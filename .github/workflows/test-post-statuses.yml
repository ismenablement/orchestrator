name: Test Post Statuses

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to test (e.g., DPTA-2222)'
        required: true
        type: string
      repo:
        description: 'Repo to dispatch to (e.g., ismenablement/repoA)'
        required: true
        type: string

jobs:
  test-dispatch:
    runs-on: ubuntu-latest
    steps:
    - name: Dispatch success to repo
      run: |
        branch="${{ inputs.branch }}"
        repo="${{ inputs.repo }}"
        echo "Dispatching to $repo for branch $branch"
        pr_number=$(gh pr list --repo $repo --head $branch --base main --json number -q '.[0].number')
        if [ -n "$pr_number" ]; then
          head_sha=$(gh pr view $pr_number --repo $repo --json headRefOid -q '.headRefOid')
          gh api /repos/$repo/dispatches -f event_type=orchestrate-success -f client_payload[head_sha]=$head_sha
          echo "Dispatched to $repo with head_sha $head_sha"
        else
          echo "No PR found for $repo on branch $branch"
        fi
      env:
        GITHUB_TOKEN: ${{ secrets.PAT_WORKFLOWS }}