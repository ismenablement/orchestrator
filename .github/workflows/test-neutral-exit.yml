name: Test Matrix with Simulated Failure

on:
  workflow_dispatch:
    inputs:
      simulate_failure:
        description: 'Simulate failure in one matrix job (yes/no)'
        required: true
        type: choice
        options:
        - 'no'
        - 'yes'

jobs:
  step1-setup:
    runs-on: ubuntu-latest
    steps:
    - name: Step 1 - Initial Setup
      run: |
        echo "Performing initial setup..."
        echo "Setup complete."

  matrix-test:
    needs: step1-setup
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        test_case: [1, 2, 3, 4, 5]
    steps:
    - name: Run Test Case
      continue-on-error: true
      run: |
        echo "Running test case ${{ matrix.test_case }}..."
        if [ "${{ inputs.simulate_failure }}" = "yes" ] && [ ${{ matrix.test_case }} -eq 3 ]; then
          echo "Simulating failure for test case 3"
          exit 1
        else
          echo "Test case ${{ matrix.test_case }} passed"
        fi

  step3-final:
    needs: matrix-test
    runs-on: ubuntu-latest
    if: always()
    steps:
    - name: Step 3 - Final Processing
      run: |
        echo "All matrix jobs completed. Performing final processing..."
        echo "Pipeline finished."

  step4-post:
    needs: step3-final
    runs-on: ubuntu-latest
    if: always()
    steps:
    - name: Step 4 - Post Processing
      run: |
        echo "Step 4: Performing post-processing after final step..."
        echo "All done."