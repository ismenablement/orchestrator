name: Trigger and Wait

on:
  workflow_call:
    inputs:
      repo:
        required: true
        type: string
      workflow:
        required: true
        type: string
      run_id:
        required: true
        type: string
    secrets:
      token:
        required: true

jobs:
  trigger-and-wait:
    runs-on: ubuntu-latest
    steps:
    - name: Trigger workflow and wait
      run: |
        echo "Triggering ${{ inputs.workflow }} on ${{ inputs.repo }}..."
        gh workflow run ${{ inputs.workflow }} --repo ${{ inputs.repo }} --field orchestrator_runid=${{ inputs.run_id }}
        echo "Workflow dispatch sent."
        
        # Poll for run ID with timeout
        timeout=60
        elapsed=0
        while [ $elapsed -lt $timeout ]; do
          run_id=$(gh run list --repo ${{ inputs.repo }} --workflow ${{ inputs.workflow }} --json databaseId,name --jq ".[] | select(.name | test(\".*${{ inputs.run_id }}\")) | .databaseId")
          if [ -n "$run_id" ]; then
            echo "Found run ID: $run_id"
            break
          fi
          echo "Run not found yet, waiting..."
          sleep 5
          elapsed=$((elapsed + 5))
        done
        
        if [ -z "$run_id" ]; then
          echo "Timeout waiting for run to start"
          exit 1
        fi
        
        echo "Waiting for ${{ inputs.workflow }} on ${{ inputs.repo }} to complete..."
        while true; do
          status=$(gh run view $run_id --repo ${{ inputs.repo }} --json status -q .status)
          conclusion=$(gh run view $run_id --repo ${{ inputs.repo }} --json conclusion -q .conclusion)
          echo "Current status: $status, conclusion: $conclusion"
          if [ "$status" = "completed" ]; then
            if [ "$conclusion" = "success" ]; then
              echo "${{ inputs.workflow }} on ${{ inputs.repo }} succeeded!"
            else
              echo "${{ inputs.workflow }} on ${{ inputs.repo }} failed with conclusion: $conclusion"
              exit 1
            fi
            break
          fi
          sleep 10
        done
      env:
        GITHUB_TOKEN: ${{ secrets.token }}