name: Orchestrate Invalidate

run-name: ${{ format('Invalidate PRs on {0} - {1}', github.event.client_payload.branch, github.run_id) }}

on:
  workflow_dispatch:
  repository_dispatch:
    types: [invalidate]

jobs:
  invalidate-prs:
    if: github.event_name == 'repository_dispatch' && github.event.client_payload.action == 'invalidate'
    runs-on: ubuntu-latest
    steps:
    - name: Post failure statuses to invalidate PRs
      run: |
        repos=("ismenablement/repoA" "ismenablement/repoB" "ismenablement/repoC" "ismenablement/repoD" "ismenablement/repoE")
        branch="${{ github.event.client_payload.branch }}"
        echo "Invalidating PRs for branch: $branch"
        for repo in "${repos[@]}"; do
          echo "Checking PR for $repo on branch $branch"
          pr_number=$(gh pr list --repo $repo --head $branch --base main --json number -q '.[0].number')
          if [ -n "$pr_number" ]; then
            head_sha=$(gh pr view $pr_number --repo $repo --json headRefOid -q '.headRefOid')
            echo "Invalidating PR #$pr_number with SHA $head_sha for $repo"
            gh api -X POST /repos/$repo/statuses/$head_sha -f state=failure -f context=orchestrator-build -f description="PR changed, re-run orchestrator"
            echo "Posted invalidate for $repo PR #$pr_number"
          else
            echo "No PR found for $repo on branch $branch"
          fi
        done
      env:
        GITHUB_TOKEN: ${{ secrets.PAT_WORKFLOWS }}